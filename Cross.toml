[build]
pre-build = [
  # Install certificates and enforce HTTPS for package sources.
  "apt-get update && apt-get install --assume-yes --no-install-recommends ca-certificates",
  "find /etc/apt/ -type f \\( -name '*.list' -o -name '*.sources' \\) -exec sed -i 's|http://|https://|g' {} +",

  # Configure APT retries/timeouts for transient network issues.
  "echo 'Acquire::Retries \"3\";' > /etc/apt/apt.conf.d/80-retries",
  "echo 'Acquire::http::Timeout \"60\";' >> /etc/apt/apt.conf.d/80-retries",
  "echo 'Acquire::ftp::Timeout \"60\";' >> /etc/apt/apt.conf.d/80-retries",

  # rust-bindgen + TLS native build deps required across crates.
  "apt-get update && apt-get install --assume-yes --no-install-recommends llvm-dev libclang-dev clang libc6-dev protobuf-compiler libssl-dev pkg-config",
]

[target.x86_64-unknown-linux-gnu]
image = "ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main"

[target.aarch64-unknown-linux-gnu]
image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu:main"

[build.env]
passthrough = ["JEMALLOC_SYS_WITH_LG_PAGE"]
