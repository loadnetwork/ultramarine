
syntax = "proto3";

import "consensus.proto";

package test;

message PeerId {
    bytes id = 1;
}

message Status {
    PeerId peer_id = 1;
    uint64 height = 2;
    uint64 earliest_height = 3;
}

message ValueRequest {
    uint64 height = 1;
    optional uint64 end_height = 2;
}

message ValueResponse {
    uint64 start_height = 1;
    repeated SyncedValue values = 2;
}

message SyncedValue {
    bytes value_bytes = 1;
    CommitCertificate certificate = 2;
}

message CommitSignature {
    // TODO: Add flag (no vote, nil, value?)
    Address validator_address = 1;
    Signature signature = 2;
}

message CommitCertificate {
    uint64 height = 1;
    uint32 round = 2;
    ValueId value_id = 3;
    repeated CommitSignature signatures = 4;
}

message ProposedValue {
    uint64 height = 1;
    uint32 round = 2;
    optional uint32 valid_round = 3;
    Address proposer = 4;
    Value value = 5;
    bool validity = 6;
}

// VoteSet types removed - no longer supported in malachite sync protocol

message SyncRequest {
  oneof request {
    ValueRequest value_request = 1;
  }
}

message SyncResponse {
  oneof response {
    ValueResponse value_response = 1;
  }
}

// Phase 5: SyncedValuePackage for state synchronization with blobs
// This goes inside RawDecidedValue.value_bytes field
message SyncedValuePackage {
  oneof package {
    FullPackage full = 1;
    MetadataOnlyPackage metadata_only = 2;
  }
}

// Full block data with execution payload and blobs
message FullPackage {
  Value value = 1;                        // Value metadata for consensus
  bytes execution_payload_ssz = 2;        // Raw execution payload bytes
  repeated BlobSidecar blob_sidecars = 3; // Blob sidecars (~131KB each)
  repeated bytes execution_requests = 4;  // Execution layer requests (EIP-7685)
  repeated ArchiveNotice archive_notices = 5; // Post-commit archive notices
}

// Metadata-only fallback (for pruned data)
// When blobs have been pruned but execution payload is still available,
// we include the payload so the receiving peer can import the block.
// This follows the Lighthouse pattern: blocks outside the DA window
// can be imported without blob sidecars.
message MetadataOnlyPackage {
  Value value = 1;  // Just the Value metadata
  repeated ArchiveNotice archive_notices = 2; // Archive notices with locators for pruned blobs
  bytes execution_payload_ssz = 3;            // Execution payload (optional, for import without blobs)
  repeated bytes execution_requests = 4;      // Execution requests (EIP-7685, optional)
}
