syntax = "proto3";

package test;

message Address {
    bytes value = 1;
}

// Phase 2: EIP-4844 blob sidecar integration
// Lightweight execution payload header for consensus voting
message ExecutionPayloadHeader {
    bytes block_hash = 1;           // 32 bytes
    bytes parent_hash = 2;          // 32 bytes
    bytes state_root = 3;           // 32 bytes
    bytes receipts_root = 4;        // 32 bytes
    bytes logs_bloom = 5;           // 256 bytes
    uint64 block_number = 6;
    uint64 gas_limit = 7;
    uint64 gas_used = 8;
    uint64 timestamp = 9;
    bytes base_fee_per_gas = 10;   // U256 as bytes
    uint64 blob_gas_used = 11;
    uint64 excess_blob_gas = 12;
    bytes prev_randao = 13;         // 32 bytes
    bytes fee_recipient = 14;       // 20 bytes
    bytes extra_data = 15;          // up to 32 bytes
    bytes transactions_root = 16;   // 32 bytes
    bytes withdrawals_root = 17;    // 32 bytes
}

// KZG commitment (48 bytes)
message KzgCommitment {
    bytes data = 1;  // 48 bytes
}

// Phase 4: Ethereum Deneb compatibility - Beacon block header
// This matches the Ethereum consensus spec BeaconBlockHeader structure
message BeaconBlockHeader {
    uint64 slot = 1;               // Slot number (height in our case)
    uint64 proposer_index = 2;     // Validator index of proposer
    bytes parent_root = 3;         // 32 bytes - root of previous header
    bytes state_root = 4;          // 32 bytes - root of state after execution
    bytes body_root = 5;           // 32 bytes - root of BeaconBlockBody
}

// Phase 4: Signed beacon block header with Ed25519 signature
// Note: Ultramarine uses Ed25519 instead of BLS12-381
message SignedBeaconBlockHeader {
    BeaconBlockHeader message = 1;
    Signature signature = 2;       // Ed25519 signature (64 bytes)
}

// Phase 2: Lightweight value metadata (~2KB)
// Contains only essential info for consensus voting
message ValueMetadata {
    ExecutionPayloadHeader execution_payload_header = 1;
    repeated KzgCommitment blob_kzg_commitments = 2;
    uint32 blob_count = 3;
    uint32 total_blob_bytes = 4;
}

// Phase 2: Value now contains metadata instead of full payload
message Value {
    uint64 value = 1;
    ValueMetadata metadata = 2;
    bytes extensions = 3;  // DEPRECATED: kept for backward compatibility
}

message ValueId {
    uint64 value = 1;
}

enum VoteType {
   PREVOTE = 0;
   PRECOMMIT = 1;
}

message Vote {
    VoteType vote_type = 1;
    uint64 height = 2;
    uint32 round = 3;
    ValueId value = 4;
    Address validator_address = 5;
}

message SignedMessage {
    oneof message {
        Proposal proposal = 1;
        Vote vote = 2;
    }
    Signature signature = 3;
}

message Proposal {
    uint64 height = 1;
    uint32 round = 2;
    Value value = 3;
    optional uint32 pol_round = 4;
    Address validator_address = 5;
}

message Signature {
    bytes bytes = 1;
}

message ProposalPart {
    oneof part {
        ProposalInit init = 1;
        ProposalData data = 2;
        BlobSidecar blob_sidecar = 3;  // Phase 3: EIP-4844 blob sidecar
        ProposalFin fin = 4;
    }
}

message ProposalInit {
    uint64 height = 1;
    uint32 round = 2;
    Address proposer = 4;
}

message ProposalData {
    bytes bytes = 1;
}

// Phase 3: Blob sidecar for streaming blobs separately from execution payload
// Phase 4: Extended with Ethereum Deneb compatibility fields
message BlobSidecar {
    uint32 index = 1;                          // Blob index (0-5 for Deneb, 0-8 for Electra, 0-1023 for Ultramarine)
    bytes blob = 2;                            // Blob data (131,072 bytes)
    bytes kzg_commitment = 3;                  // KZG commitment (48 bytes)
    bytes kzg_proof = 4;                       // KZG proof (48 bytes)

    // Phase 4: Ethereum Deneb compatibility fields
    SignedBeaconBlockHeader signed_block_header = 5;  // Signed header (~192 bytes)
    repeated bytes kzg_commitment_inclusion_proof = 6; // 17-branch Merkle proof (17 Ã— 32 = 544 bytes)
}

message ProposalFin {
    Signature signature = 1;
}

message Extension {
    bytes data = 1;
    Signature signature = 2;
}

message StreamMessage {
    bytes stream_id = 1;
    uint64 sequence = 2;
    oneof content {
        // Serialized content.
        bytes data = 3;
        // Fin must be set to true.
        bool fin = 4;
    }
}

// Phase 4: Three-layer architecture - Layer 1 (Pure BFT Consensus)
// Pure consensus-layer block metadata using BFT terminology only.
// Contains NO Ethereum types for technology neutrality.
message ConsensusBlockMetadata {
    uint64 height = 1;              // Block height (NOT "slot")
    int32 round = 2;                // Consensus round
    Address proposer = 3;           // Validator who proposed (NOT "proposer_index")
    uint64 timestamp = 4;           // Unix timestamp (seconds)
    bytes validator_set_hash = 5;   // B256 (32 bytes)
    bytes execution_block_hash = 6; // B256 (32 bytes)
    uint64 gas_limit = 7;
    uint64 gas_used = 8;
}

// Phase 4: Three-layer architecture - Layer 2 (Ethereum Compatibility)
// Ethereum EIP-4844 compatibility metadata.
// This is the bridge between Ultramarine consensus and Ethereum blob format.
// Conversion to BeaconBlockHeader happens only when building BlobSidecars.
message BlobMetadata {
    uint64 height = 1;                     // Block height (maps to Ethereum slot)
    bytes parent_blob_root = 2;            // B256 (32 bytes) - chains blob headers
    repeated bytes kzg_commitments = 3;    // 48 bytes each
    uint32 blob_count = 4;                 // Number of blobs (0 for blobless)
    ExecutionPayloadHeader execution_payload_header = 5;
    optional uint64 proposer_index_hint = 6;
}
