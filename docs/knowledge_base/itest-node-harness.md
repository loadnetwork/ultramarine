# Tier‑1 Full‑Node Harness Notes

## Purpose

Document invariants and failure modes for the Tier‑1 full‑node harness (`make itest-node`).
These tests are **integration‑critical** for Engine API gating, proposal flow, and blob handling.

## Key Invariant: Engine Stub Block Hashes

The Engine API stub encodes test heights into synthetic block hashes:

- `block_hash_for_height(h)` → `B256([h as u8; 32])`
- `height_from_block_hash(hash)` **only** returns a height if **all bytes match**
  (i.e., the hash was generated by `block_hash_for_height`).

This prevents the stub from interpreting a real genesis hash as a “height” and
silently jumping its internal head.

## Failure Mode (What Breaks)

If the stub interprets arbitrary block hashes as heights (e.g., using only `hash[0]`):

- A real genesis hash can be misread as height ~200+.
- `forkchoiceUpdated` updates `latest_block` to the wrong height.
- `getPayload` builds on a mismatched head → `BuiltPayloadMismatch` in
  `crates/execution/src/client.rs`.
- Tier‑1 tests fail with missing blobs (proposal never materializes).

## Fix (2026‑01‑26)

Hardened `height_from_block_hash` to return a height **only** when the hash
matches the synthetic pattern.

Code:

- `crates/test/tests/full_node/node_harness.rs`
  - `height_from_block_hash()` checks all bytes are identical before returning a height.

## Tests

Run from `ultramarine/`:

- `make itest-node`

## Related

- CL↔EL head gate: `docs/knowledge_base/cl-el-head-gating.md`
- BUG‑013 postmortem: `docs/journal/BUG-013-chain-split-parent-mismatch.md`
