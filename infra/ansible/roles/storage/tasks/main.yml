---
- name: Optionally disable apt proxy
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/99loadnet-no-proxy
    owner: root
    group: root
    mode: "0644"
    content: |
      Acquire::http::Proxy "false";
      Acquire::https::Proxy "false";
      Acquire::ftp::Proxy "false";
  when: loadnet_apt_disable_proxy | default(false) | bool

- name: Install storage dependencies
  block:
    - name: Install storage dependencies (with cache update)
      ansible.builtin.apt:
        name:
          - mdadm
          - xfsprogs
          - rsync
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
        update_cache_retries: "{{ loadnet_apt_update_retries | default(10) }}"
        update_cache_retry_max_delay: "{{ loadnet_apt_update_max_delay | default(30) }}"
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"
  rescue:
    - name: Warn about apt cache update failure
      ansible.builtin.debug:
        msg: "apt cache update failed; retrying install without update_cache."
    - name: Install storage dependencies (without cache update)
      ansible.builtin.apt:
        name:
          - mdadm
          - xfsprogs
          - rsync
        state: present
        update_cache: false
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"

- name: Assert required inputs for destructive mode
  ansible.builtin.assert:
    that:
      - loadnet_storage_wipe | bool
      - loadnet_data_devices is iterable
      - (loadnet_data_devices | length) >= 1
    fail_msg: "Destructive storage bootstrap requires loadnet_storage_wipe=true and explicit loadnet_data_devices=[/dev/disk/by-id/...]"
  when: loadnet_storage_wipe | bool

- name: Ensure mountpoint exists
  ansible.builtin.file:
    path: "{{ loadnet_data_mountpoint }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create mdadm array (RAID1 or RAID0) (destructive)
  ansible.builtin.command: >-
    mdadm --create {{ loadnet_md_device }}
    --name {{ loadnet_md_name }}
    --level {{ loadnet_data_raid_level }}
    --raid-devices {{ loadnet_data_devices | length }}
    {{ loadnet_data_devices | join(' ') }}
  when:
    - loadnet_storage_wipe | bool
    - (loadnet_data_devices | length) >= 2
  changed_when: true

- name: Persist mdadm config (destructive)
  ansible.builtin.shell: |
    set -euo pipefail
    mdadm --detail --scan | tee /etc/mdadm/mdadm.conf >/dev/null
    update-initramfs -u
  args:
    executable: /bin/bash
  when:
    - loadnet_storage_wipe | bool
    - (loadnet_data_devices | length) >= 2
  changed_when: true

- name: Create filesystem on md device (destructive)
  ansible.builtin.command: "mkfs.{{ loadnet_fs_type }} -f {{ loadnet_md_device }}"
  when:
    - loadnet_storage_wipe | bool
    - (loadnet_data_devices | length) >= 2
  changed_when: true

- name: Create filesystem on single device (destructive)
  ansible.builtin.command: "mkfs.{{ loadnet_fs_type }} -f {{ loadnet_data_devices[0] }}"
  when:
    - loadnet_storage_wipe | bool
    - (loadnet_data_devices | length) == 1
  changed_when: true

- name: Get filesystem UUID
  ansible.builtin.command: "blkid -s UUID -o value {{ (loadnet_data_devices | length) >= 2 | ternary(loadnet_md_device, loadnet_data_devices[0]) }}"
  register: loadnet_fs_uuid
  changed_when: false
  when: loadnet_storage_wipe | bool

- name: Persist fstab entry (destructive)
  ansible.builtin.lineinfile:
    path: /etc/fstab
    create: true
    mode: "0644"
    line: "UUID={{ loadnet_fs_uuid.stdout }} {{ loadnet_data_mountpoint }} {{ loadnet_fs_type }} defaults,noatime 0 2"
    regexp: "^UUID={{ loadnet_fs_uuid.stdout | regex_escape() }}\\s+{{ loadnet_data_mountpoint | regex_escape() }}\\s+"
  when: loadnet_storage_wipe | bool

- name: Mount data volume (destructive)
  ansible.builtin.command: "mount {{ loadnet_data_mountpoint }}"
  when: loadnet_storage_wipe | bool
  changed_when: true

- name: Verify data mount is present (after destructive bootstrap)
  ansible.builtin.command: "findmnt -n {{ loadnet_data_mountpoint }}"
  changed_when: false
  when: loadnet_storage_wipe | bool

- name: Verify data mount is present (non-destructive mode)
  ansible.builtin.command: "findmnt -n {{ loadnet_data_mountpoint }}"
  changed_when: false
  when: not (loadnet_storage_wipe | bool)
  register: mount_check
  failed_when: false

- name: Get root filesystem source device (for safety checks)
  ansible.builtin.command: "findmnt -n -o SOURCE /"
  changed_when: false
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
  register: root_source

- name: Lookup configured source mount (auto-adopt)
  ansible.builtin.set_fact:
    loadnet_configured_source_mount: >-
      {{
        (ansible_facts.mounts | selectattr('mount', 'equalto', loadnet_data_source_mountpoint) | list | first)
        | default({})
      }}
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0

- name: Build auto-adopt candidate list (non-root mounts)
  ansible.builtin.set_fact:
    loadnet_mount_candidates: >-
      {{
        ansible_facts.mounts
        | rejectattr('mount', 'equalto', '/')
        | rejectattr('mount', 'match', '^/boot')
        | rejectattr('mount', 'match', '^/efi')
        | rejectattr('fstype', 'in', loadnet_mount_excluded_fstypes)
        | rejectattr('device', 'equalto', root_source.stdout)
        | list
      }}
  vars:
    loadnet_mount_excluded_fstypes:
      - tmpfs
      - devtmpfs
      - overlay
      - squashfs
      - proc
      - sysfs
      - cgroup
      - cgroup2
      - mqueue
      - pstore
      - tracefs
      - debugfs
      - securityfs
      - fusectl
      - rpc_pipefs
      - autofs
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0

- name: Select auto-adopt source mount when configured mount is missing
  ansible.builtin.set_fact:
    loadnet_auto_source_mount: "{{ loadnet_mount_candidates[0] }}"
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_configured_source_mount | length == 0
    - loadnet_mount_candidates | length == 1

- name: Warn when multiple non-root mount candidates exist
  ansible.builtin.debug:
    msg: >-
      Multiple non-root mountpoints detected: {{ loadnet_mount_candidates | map(attribute='mount') | list }}.
      Set loadnet_data_source_mountpoint explicitly to select one.
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_configured_source_mount | length == 0
    - loadnet_mount_candidates | length > 1

- name: Select effective source mount (configured or auto-detected)
  ansible.builtin.set_fact:
    loadnet_effective_source_mount: >-
      {{
        (loadnet_configured_source_mount | length > 0)
        | ternary(loadnet_configured_source_mount, loadnet_auto_source_mount | default({}))
      }}
    loadnet_effective_source_mountpoint: >-
      {{
        (loadnet_configured_source_mount | length > 0)
        | ternary(loadnet_configured_source_mount.mount, (loadnet_auto_source_mount | default({})).mount | default(''))
      }}
    loadnet_effective_source_device: >-
      {{
        (loadnet_configured_source_mount | length > 0)
        | ternary(loadnet_configured_source_mount.device, (loadnet_auto_source_mount | default({})).device | default(''))
      }}
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0

- name: Select effective source dir
  ansible.builtin.set_fact:
    loadnet_effective_source_dir: >-
      {{
        (loadnet_configured_source_mount | length > 0)
        | ternary(loadnet_data_source_dir,
                  (loadnet_effective_source_mountpoint != '') | ternary(loadnet_effective_source_mountpoint + '/loadnet', ''))
      }}
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0

- name: Fail safely if source mountpoint is on the root filesystem (refuse to use OS disk)
  ansible.builtin.fail:
    msg: >-
      Refusing to auto-adopt {{ loadnet_effective_source_mountpoint }} because it appears to be on the root filesystem
      (SOURCE {{ loadnet_effective_source_device }} == {{ root_source.stdout }}). Mount a separate data volume at {{ loadnet_data_mountpoint }}
      or provide explicit loadnet_data_devices + loadnet_storage_wipe=true.
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_effective_source_mountpoint != ''
    - loadnet_effective_source_device == root_source.stdout

- name: Ensure source dir exists (auto-adopt)
  ansible.builtin.file:
    path: "{{ loadnet_effective_source_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_effective_source_mountpoint != ''
    - loadnet_effective_source_device != root_source.stdout

- name: Bind-mount source dir into data mountpoint (auto-adopt)
  ansible.builtin.command: "mount --bind {{ loadnet_effective_source_dir }} {{ loadnet_data_mountpoint }}"
  changed_when: true
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_effective_source_mountpoint != ''
    - loadnet_effective_source_device != root_source.stdout

- name: Persist bind-mount in fstab (auto-adopt)
  ansible.builtin.lineinfile:
    path: /etc/fstab
    create: true
    mode: "0644"
    line: "{{ loadnet_effective_source_dir }} {{ loadnet_data_mountpoint }} none bind,x-systemd.requires-mounts-for={{ loadnet_effective_source_mountpoint }} 0 0"
    regexp: "^{{ loadnet_effective_source_dir | regex_escape() }}\\s+{{ loadnet_data_mountpoint | regex_escape() }}\\s+none\\s+"
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - loadnet_effective_source_mountpoint != ''
    - loadnet_effective_source_device != root_source.stdout

- name: Re-check data mount is present after auto-adopt
  ansible.builtin.command: "findmnt -n {{ loadnet_data_mountpoint }}"
  changed_when: false
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
  register: mount_check_after
  failed_when: false

- name: Fail with guidance if data mount is missing (non-destructive mode)
  ansible.builtin.fail:
    msg: >-
      {{ loadnet_data_mountpoint }} is not mounted.
      Either mount your data volume there, or run net-storage with loadnet_storage_wipe=true and explicit loadnet_data_devices.
      If your provider image mounts the data volume elsewhere, set loadnet_data_source_mountpoint (default: /home)
      and/or loadnet_data_source_dir (default: /home/loadnet).
      Detected mountpoints: {{ loadnet_mount_candidates | default([]) | map(attribute='mount') | list }}.
  when:
    - not (loadnet_storage_wipe | bool)
    - mount_check.rc != 0
    - mount_check_after.rc != 0

- name: Check existing /var/log mount
  ansible.builtin.command: "findmnt -n -o SOURCE /var/log"
  changed_when: false
  failed_when: false
  register: loadnet_var_log_source

- name: Bind-mount /var/log to data volume (optional)
  when:
    - loadnet_bind_var_log | bool
    - loadnet_var_log_source.rc != 0 or loadnet_var_log_source.stdout != loadnet_log_dir
  block:
    - name: Ensure log dir on data volume exists
      ansible.builtin.file:
        path: "{{ loadnet_log_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Sync existing logs to data volume
      ansible.builtin.command: "rsync -aHAX /var/log/ {{ loadnet_log_dir }}/"
      changed_when: true

    - name: Bind-mount log dir onto /var/log
      ansible.builtin.command: "mount --bind {{ loadnet_log_dir }} /var/log"
      changed_when: true

    - name: Persist /var/log bind-mount in fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        create: true
        mode: "0644"
        line: "{{ loadnet_log_dir }} /var/log none bind,x-systemd.requires-mounts-for={{ loadnet_data_mountpoint }} 0 0"
        regexp: "^{{ loadnet_log_dir | regex_escape() }}\\s+/var/log\\s+none\\s+"

- name: Ensure chain state dirs exist under data mount
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ loadnet_data_mountpoint }}/load-reth"
    - "{{ loadnet_data_mountpoint }}/ultramarine"

- name: Symlink /var/lib/load-reth to data mount
  ansible.builtin.file:
    src: "{{ loadnet_data_mountpoint }}/load-reth"
    dest: /var/lib/load-reth
    state: link
    force: true

- name: Symlink /var/lib/ultramarine to data mount
  ansible.builtin.file:
    src: "{{ loadnet_data_mountpoint }}/ultramarine"
    dest: /var/lib/ultramarine
    state: link
    force: true

- name: Ensure Docker data-root dir exists (optional)
  ansible.builtin.file:
    path: "{{ loadnet_docker_dataroot }}"
    state: directory
    owner: root
    group: root
    mode: "0711"
  when: loadnet_move_docker_dataroot | bool

- name: Ensure /etc/docker exists (optional)
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: loadnet_move_docker_dataroot | bool

- name: Check if docker service exists (optional)
  ansible.builtin.command: "systemctl status docker"
  changed_when: false
  failed_when: false
  register: loadnet_docker_status
  when: loadnet_move_docker_dataroot | bool

- name: Check for existing docker data (optional)
  ansible.builtin.stat:
    path: /var/lib/docker
  register: loadnet_docker_data
  when: loadnet_move_docker_dataroot | bool

- name: Configure Docker data-root (optional)
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: "0644"
    content: |
      {
        "data-root": "{{ loadnet_docker_dataroot }}"
      }
  register: docker_daemon_json
  when: loadnet_move_docker_dataroot | bool

- name: Stop docker before moving data-root (optional)
  ansible.builtin.systemd:
    name: docker
    state: stopped
  when:
    - loadnet_move_docker_dataroot | bool
    - docker_daemon_json.changed
    - loadnet_docker_status.rc != 4

- name: Migrate existing docker state (optional, best-effort)
  ansible.builtin.command: "rsync -aHAX --delete /var/lib/docker/ {{ loadnet_docker_dataroot }}/"
  when:
    - loadnet_move_docker_dataroot | bool
    - docker_daemon_json.changed
    - loadnet_docker_data.stat.exists
  changed_when: true
  failed_when: false

- name: Start docker after moving data-root (optional)
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true
  when:
    - loadnet_move_docker_dataroot | bool
    - docker_daemon_json.changed
    - loadnet_docker_status.rc != 4
