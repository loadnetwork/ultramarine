---
- name: Check if nginx is enabled for this host
  ansible.builtin.meta: end_host
  when: not (blockscout_nginx_enabled | default(false) | bool)

- name: Install certbot
  block:
    - name: Install certbot (with cache update)
      ansible.builtin.apt:
        name:
          - certbot
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
        update_cache_retries: "{{ loadnet_apt_update_retries | default(10) }}"
        update_cache_retry_max_delay: "{{ loadnet_apt_update_max_delay | default(30) }}"
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"
  rescue:
    - name: Warn about apt cache update failure
      ansible.builtin.debug:
        msg: "apt cache update failed; retrying install without update_cache."
    - name: Install certbot (without cache update)
      ansible.builtin.apt:
        name:
          - certbot
        state: present
        update_cache: false
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"

- name: Create nginx directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ blockscout_nginx_config_dir }}"
    - "{{ blockscout_nginx_config_dir }}/conf.d"
    - "{{ blockscout_nginx_webroot }}"
    - "{{ blockscout_nginx_webroot }}/.well-known"
    - "{{ blockscout_nginx_webroot }}/.well-known/acme-challenge"

- name: Check if nginx.conf is a directory
  ansible.builtin.stat:
    path: "{{ blockscout_nginx_config_dir }}/nginx.conf"
  register: nginx_conf_stat

- name: Remove nginx.conf if it's a directory (prevents mount failure)
  ansible.builtin.file:
    path: "{{ blockscout_nginx_config_dir }}/nginx.conf"
    state: absent
  when: nginx_conf_stat.stat.exists and nginx_conf_stat.stat.isdir

- name: Render main nginx configuration
  ansible.builtin.template:
    src: "nginx.conf.j2"
    dest: "{{ blockscout_nginx_config_dir }}/nginx.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart nginx

- name: Render blockscout site configuration
  ansible.builtin.template:
    src: "sites/blockscout.conf.j2"
    dest: "{{ blockscout_nginx_config_dir }}/conf.d/blockscout.conf"
    owner: root
    group: root
    mode: "0644"
  notify: Restart nginx

- name: Install nginx-blockscout systemd unit
  ansible.builtin.template:
    src: "nginx.service.j2"
    dest: "/etc/systemd/system/nginx-blockscout.service"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart nginx-blockscout

- name: Include certbot tasks
  ansible.builtin.include_tasks: certbot.yml
  when: blockscout_nginx_ssl_enabled | default(true) | bool

- name: Enable and start nginx-blockscout service
  ansible.builtin.systemd:
    name: nginx-blockscout
    enabled: true
    state: started
    daemon_reload: true
