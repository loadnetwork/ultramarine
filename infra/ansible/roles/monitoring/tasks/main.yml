---
- name: Resolve repo root fallback
  ansible.builtin.set_fact:
    loadnet_repo_root: "{{ loadnet_repo_root | default(playbook_dir | dirname | dirname | dirname) }}"

- name: Validate monitoring asset paths on controller
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ loadnet_repo_root }}/monitoring/config-grafana/grafana.ini"
    - "{{ loadnet_repo_root }}/monitoring/config-grafana/provisioning/dashboards/default.yml"
    - "{{ loadnet_repo_root }}/monitoring/config-grafana/provisioning/dashboards-data/default.json"
  register: loadnet_monitoring_assets
  delegate_to: localhost
  become: false
  run_once: true

- name: Assert monitoring assets exist on controller
  ansible.builtin.assert:
    that:
      - loadnet_monitoring_assets.results | map(attribute='stat.exists') | min
    fail_msg: "monitoring assets missing on controller; run deploy from repo checkout with ultramarine/monitoring present"
  run_once: true

- name: Ensure monitoring secrets dir exists (controller-side)
  ansible.builtin.file:
    path: "{{ net_dir }}/bundle/private/monitoring"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: false
  run_once: true

- name: Write Grafana admin password env from extra var (controller-side)
  ansible.builtin.copy:
    dest: "{{ net_dir }}/bundle/private/monitoring/grafana_admin_password.env"
    mode: "0600"
    content: |
      GRAFANA_ADMIN_PASSWORD_B64={{ loadnet_grafana_admin_password | b64encode }}
  no_log: true
  delegate_to: localhost
  become: false
  run_once: true
  when:
    - loadnet_grafana_admin_password is defined
    - (loadnet_grafana_admin_password | length) > 0

- name: Check for Grafana admin password env (controller-side)
  ansible.builtin.stat:
    path: "{{ net_dir }}/bundle/private/monitoring/grafana_admin_password.env"
  register: loadnet_grafana_secret_stat
  delegate_to: localhost
  become: false
  run_once: true

- name: Initialize Grafana admin password env body
  ansible.builtin.set_fact:
    loadnet_grafana_secret_body: ""
  no_log: true

- name: Read Grafana admin password env (controller-side)
  ansible.builtin.set_fact:
    loadnet_grafana_secret_body: "{{ lookup('ansible.builtin.file', net_dir + '/bundle/private/monitoring/grafana_admin_password.env') }}"
  no_log: true
  when: loadnet_grafana_secret_stat.stat.exists

- name: Parse Grafana admin password (from secrets)
  ansible.builtin.set_fact:
    loadnet_grafana_admin_password_b64: >-
      {{
        (loadnet_grafana_secret_body
        | regex_findall('^GRAFANA_ADMIN_PASSWORD_B64=\"?(.*)\"?$', multiline=True)
        | first
        | default('', true))
      }}
    loadnet_grafana_admin_password_plain: >-
      {{
        (loadnet_grafana_secret_body
        | regex_findall('^GRAFANA_ADMIN_PASSWORD=\"?(.*)\"?$', multiline=True)
        | first
        | default('', true))
      }}
  no_log: true

- name: Generate Grafana admin password env (controller-side)
  ansible.builtin.copy:
    dest: "{{ net_dir }}/bundle/private/monitoring/grafana_admin_password.env"
    mode: "0600"
    content: |
      GRAFANA_ADMIN_PASSWORD_B64={{ lookup('ansible.builtin.password', net_dir + '/bundle/private/monitoring/.grafana_admin_password length=32 chars=ascii_letters,digits') | b64encode }}
  no_log: true
  delegate_to: localhost
  become: false
  run_once: true
  when:
    - (not loadnet_grafana_secret_stat.stat.exists)
      or ((loadnet_grafana_admin_password_b64 | length) == 0 and (loadnet_grafana_admin_password_plain | length) == 0)

- name: Refresh Grafana admin password env (controller-side)
  ansible.builtin.set_fact:
    loadnet_grafana_secret_body: "{{ lookup('ansible.builtin.file', net_dir + '/bundle/private/monitoring/grafana_admin_password.env') }}"
  no_log: true

- name: Re-parse Grafana admin password (from secrets)
  ansible.builtin.set_fact:
    loadnet_grafana_admin_password_b64: >-
      {{
        (loadnet_grafana_secret_body
        | regex_findall('^GRAFANA_ADMIN_PASSWORD_B64=\"?(.*)\"?$', multiline=True)
        | first
        | default('', true))
      }}
    loadnet_grafana_admin_password_plain: >-
      {{
        (loadnet_grafana_secret_body
        | regex_findall('^GRAFANA_ADMIN_PASSWORD=\"?(.*)\"?$', multiline=True)
        | first
        | default('', true))
      }}
  no_log: true

- name: Set Grafana admin password value
  ansible.builtin.set_fact:
    loadnet_grafana_admin_password_value: >-
      {{
        (loadnet_grafana_admin_password_b64 | length > 0)
        | ternary(loadnet_grafana_admin_password_b64 | b64decode, loadnet_grafana_admin_password_plain)
      }}
  no_log: true

- name: Assert Grafana admin password is present
  ansible.builtin.assert:
    that:
      - (loadnet_grafana_admin_password_value | default('', true) | length) > 0
    fail_msg: "grafana admin password is missing or empty (expected {{ net_dir }}/bundle/private/monitoring/grafana_admin_password.env)"
  no_log: true

- name: Build node->details map (from lockfile)
  ansible.builtin.set_fact:
    loadnet_nodes_by_id: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes)) }}"

- name: Build host node list for monitoring
  ansible.builtin.set_fact:
    loadnet_host_nodes: "{{ loadnet_nodes | map('extract', loadnet_nodes_by_id) | list }}"

- name: Ensure monitoring directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ loadnet_net_dir }}/monitoring"
    - "{{ loadnet_net_dir }}/monitoring/grafana"
    - "{{ loadnet_net_dir }}/monitoring/grafana/provisioning"
    - "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/dashboards"
    - "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/dashboards-data"
    - "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/datasources"

- name: Ensure monitoring data directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "0755"
  loop:
    - { path: "/var/lib/grafana", owner: "472", group: "472" }
    - { path: "/var/lib/prometheus", owner: "65534", group: "65534" }

- name: Render Prometheus config for host nodes
  ansible.builtin.template:
    src: "prometheus.yml.j2"
    dest: "{{ loadnet_net_dir }}/monitoring/prometheus.yml"
    owner: root
    group: root
    mode: "0644"

- name: Render Grafana base config
  ansible.builtin.template:
    src: "grafana.ini.j2"
    dest: "{{ loadnet_net_dir }}/monitoring/grafana/grafana.ini"
    owner: "472"
    group: "472"
    mode: "0640"

- name: Copy Grafana dashboards provisioning config
  ansible.builtin.copy:
    src: "{{ loadnet_repo_root }}/monitoring/config-grafana/provisioning/dashboards/default.yml"
    dest: "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/dashboards/default.yml"
    owner: root
    group: root
    mode: "0644"

- name: Copy Grafana dashboards data
  ansible.builtin.copy:
    src: "{{ loadnet_repo_root }}/monitoring/config-grafana/provisioning/dashboards-data/default.json"
    dest: "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/dashboards-data/default.json"
    owner: root
    group: root
    mode: "0644"

- name: Render Grafana Prometheus datasource
  ansible.builtin.template:
    src: "grafana-prometheus.yml.j2"
    dest: "{{ loadnet_net_dir }}/monitoring/grafana/provisioning/datasources/prometheus.yml"
    owner: root
    group: root
    mode: "0644"
