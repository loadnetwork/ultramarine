---
- name: Optionally disable apt proxy
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/99loadnet-no-proxy
    owner: root
    group: root
    mode: "0644"
    content: |
      Acquire::http::Proxy "false";
      Acquire::https::Proxy "false";
      Acquire::ftp::Proxy "false";
  when: loadnet_apt_disable_proxy | default(false) | bool

- name: Install dependencies
  block:
    - name: Install dependencies (with cache update)
      ansible.builtin.apt:
        name:
          - docker.io
          - curl
          - jq
          - chrony
          - logrotate
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
        update_cache_retries: "{{ loadnet_apt_update_retries | default(10) }}"
        update_cache_retry_max_delay: "{{ loadnet_apt_update_max_delay | default(30) }}"
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"
  rescue:
    - name: Warn about apt cache update failure
      ansible.builtin.debug:
        msg: "apt cache update failed; retrying install without update_cache."
    - name: Install dependencies (without cache update)
      ansible.builtin.apt:
        name:
          - docker.io
          - curl
          - jq
          - chrony
          - logrotate
        state: present
        update_cache: false
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"

- name: Enable and start docker
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started

- name: Enable and start chrony (time sync)
  ansible.builtin.systemd:
    name: chrony
    enabled: true
    state: started

- name: Configure sysctl baseline
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-loadnet.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Load Network baseline (multi-host)
      fs.file-max = 1048576

      # High-performance TCP settings for 100k+ TPS
      net.ipv4.ip_local_port_range = 1024 65535
      net.ipv4.tcp_tw_reuse = 1
      net.core.somaxconn = 65535
      net.ipv4.tcp_max_syn_backlog = 65535
      net.core.netdev_max_backlog = 65535
      net.ipv4.tcp_fin_timeout = 15
      net.ipv4.tcp_keepalive_time = 300
      net.ipv4.tcp_keepalive_intvl = 30
      net.ipv4.tcp_keepalive_probes = 5
      net.netfilter.nf_conntrack_max = 1048576
      net.netfilter.nf_conntrack_tcp_timeout_established = 1800

      # Network buffers for high throughput
      net.core.rmem_max = 134217728
      net.core.wmem_max = 134217728
      net.ipv4.tcp_rmem = 4096 87380 134217728
      net.ipv4.tcp_wmem = 4096 65536 134217728
  notify: Apply sysctl settings

- name: Configure user file descriptor limits
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-loadnet.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Load Network high performance limits
      *               soft    nofile          1048576
      *               hard    nofile          1048576
      ubuntu          soft    nofile          1048576
      ubuntu          hard    nofile          1048576
      root            soft    nofile          1048576
      root            hard    nofile          1048576

- name: Create base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /opt/loadnet
    - /opt/loadnet/networks

- name: Ensure journald drop-in dir exists
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Configure journald limits (prevent root disk exhaustion)
  ansible.builtin.copy:
    dest: /etc/systemd/journald.conf.d/loadnet.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [Journal]
      SystemMaxUse={{ loadnet_journal_max_use | default('2G') }}
      SystemMaxFileSize={{ loadnet_journal_max_file_size | default('200M') }}
      MaxRetentionSec={{ loadnet_journal_max_retention | default('7day') }}
      ForwardToSyslog={{ (loadnet_forward_journal_to_syslog | default(false)) | ternary('yes', 'no') }}
  notify: Restart journald

- name: Install rsyslog logrotate policy (size-based)
  ansible.builtin.copy:
    dest: /etc/logrotate.d/rsyslog
    owner: root
    group: root
    mode: "0644"
    content: |
      /var/log/syslog
      {
          size {{ loadnet_syslog_max_size | default('100M') }}
          rotate {{ loadnet_syslog_max_files | default(5) }}
          missingok
          notifempty
          compress
          delaycompress
          copytruncate
          sharedscripts
          postrotate
              /usr/lib/rsyslog/rsyslog-rotate || true
          endscript
      }
  when: loadnet_forward_journal_to_syslog | default(false)

- name: Install systemd unit templates
  ansible.builtin.template:
    src: "{{ (playbook_dir | dirname | dirname) }}/templates/systemd/{{ item.src }}"
    dest: "/etc/systemd/system/{{ item.dest }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - { src: "load-reth@.service.j2", dest: "load-reth@.service" }
    - { src: "ultramarine@.service.j2", dest: "ultramarine@.service" }
    - { src: "prometheus.service.j2", dest: "prometheus.service" }
    - { src: "grafana.service.j2", dest: "grafana.service" }
