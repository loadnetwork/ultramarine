---
- name: Optionally disable apt proxy
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/99loadnet-no-proxy
    owner: root
    group: root
    mode: "0644"
    content: |
      Acquire::http::Proxy "false";
      Acquire::https::Proxy "false";
      Acquire::ftp::Proxy "false";
  when: loadnet_apt_disable_proxy | default(false) | bool

- name: Install ufw
  block:
    - name: Install ufw (with cache update)
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
        update_cache_retries: "{{ loadnet_apt_update_retries | default(10) }}"
        update_cache_retry_max_delay: "{{ loadnet_apt_update_max_delay | default(30) }}"
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"
  rescue:
    - name: Warn about apt cache update failure
      ansible.builtin.debug:
        msg: "apt cache update failed; retrying install without update_cache."
    - name: Install ufw (without cache update)
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: false
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"

- name: Ensure SSH stays allowed (never lock out the operator)
  ansible.builtin.command: "ufw allow {{ ansible_port | default(22) }}/tcp"
  changed_when: false

- name: Set UFW default policies (safe baseline)
  ansible.builtin.command: "ufw default {{ item }}"
  loop:
    - deny incoming
    - allow outgoing
  changed_when: false

- name: Build node->ports map (from lockfile)
  ansible.builtin.set_fact:
    loadnet_ports_by_node: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes | map(attribute='ports'))) }}"

- name: Open required P2P ports for nodes on this host
  ansible.builtin.shell: |
    set -euo pipefail
    ufw allow "{{ loadnet_ports_by_node[node_id].el_p2p }}/tcp"
    ufw allow "{{ loadnet_ports_by_node[node_id].el_p2p }}/udp"
    ufw allow "{{ loadnet_ports_by_node[node_id].cl_p2p }}/tcp"
    ufw allow "{{ loadnet_ports_by_node[node_id].cl_mempool }}/tcp"
  args:
    executable: /bin/bash
  loop: "{{ loadnet_nodes }}"
  loop_control:
    loop_var: node_id
  changed_when: false

- name: Open EL HTTP ports for nodes on this host
  ansible.builtin.command: "ufw allow {{ loadnet_ports_by_node[node_id].el_http }}/tcp"
  loop: "{{ loadnet_nodes }}"
  loop_control:
    loop_var: node_id
  changed_when: false
  when: (loadnet_el_http_bind | default('0.0.0.0')) not in ['127.0.0.1', '::1']

- name: Open Grafana port (monitoring)
  ansible.builtin.command: "ufw allow {{ loadnet_grafana_port | default(3000) }}/tcp"
  changed_when: false
  when: (loadnet_grafana_bind | default('0.0.0.0')) not in ['127.0.0.1', '::1']

- name: Open Prometheus port (monitoring)
  ansible.builtin.command: "ufw allow {{ loadnet_prometheus_port | default(9090) }}/tcp"
  changed_when: false
  when: (loadnet_prometheus_bind | default('127.0.0.1')) not in ['127.0.0.1', '::1']

- name: Enable ufw (idempotent)
  ansible.builtin.command: "ufw --force enable"
  changed_when: false

- name: Show ufw status
  ansible.builtin.command: "ufw status verbose"
  changed_when: false
