---
- name: Check if blockscout is enabled for this host
  ansible.builtin.debug:
    msg: "Blockscout deployment is disabled for this host"
  when: not (blockscout_enabled | default(false) | bool)

- name: End play if blockscout is not enabled
  ansible.builtin.meta: end_host
  when: not (blockscout_enabled | default(false) | bool)

- name: Ensure Docker Compose is available
  block:
    - name: Install docker-compose-plugin (preferred)
      ansible.builtin.apt:
        name: docker-compose-plugin
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
  rescue:
    - name: Install docker-compose (legacy fallback)
      ansible.builtin.apt:
        name: docker-compose
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"

- name: Detect docker binary
  ansible.builtin.command: which docker
  register: blockscout_docker_path
  changed_when: false
  failed_when: false

- name: Detect docker compose v2
  ansible.builtin.command: "{{ blockscout_docker_path.stdout }} compose version"
  register: blockscout_compose_v2_check
  changed_when: false
  failed_when: false
  when: blockscout_docker_path.rc == 0

- name: Detect docker-compose v1
  ansible.builtin.command: which docker-compose
  register: blockscout_compose_v1_path
  changed_when: false
  failed_when: false

- name: Set blockscout compose command
  ansible.builtin.set_fact:
    blockscout_compose_cmd: >-
      {{
        (blockscout_docker_path.rc | default(1) == 0 and blockscout_compose_v2_check.rc | default(1) == 0)
          | ternary(blockscout_docker_path.stdout + ' compose', blockscout_compose_v1_path.stdout | default(''))
      }}

- name: Assert docker compose is available
  ansible.builtin.assert:
    that:
      - blockscout_compose_cmd | length > 0
    fail_msg: "docker compose not found; install docker-compose-plugin or docker-compose"

- name: Ensure rsync is available (required for synchronize)
  block:
    - name: Install rsync (with cache update)
      ansible.builtin.apt:
        name: rsync
        state: present
        update_cache: true
        cache_valid_time: "{{ loadnet_apt_cache_valid_time | default(3600) }}"
        update_cache_retries: "{{ loadnet_apt_update_retries | default(10) }}"
        update_cache_retry_max_delay: "{{ loadnet_apt_update_max_delay | default(30) }}"
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"
  rescue:
    - name: Warn about apt cache update failure
      ansible.builtin.debug:
        msg: "apt cache update failed; retrying rsync install without update_cache."
    - name: Install rsync (without cache update)
      ansible.builtin.apt:
        name: rsync
        state: present
        update_cache: false
        lock_timeout: "{{ loadnet_apt_lock_timeout | default(120) }}"

- name: Ensure blockscout secrets dir exists (controller-side)
  ansible.builtin.file:
    path: "{{ net_dir }}/bundle/private/blockscout"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: false
  run_once: true

- name: Check for blockscout DB password (controller-side)
  ansible.builtin.stat:
    path: "{{ net_dir }}/bundle/private/blockscout/db_password"
  register: blockscout_db_password_stat
  delegate_to: localhost
  become: false
  run_once: true

- name: Generate blockscout DB password (controller-side)
  ansible.builtin.copy:
    dest: "{{ net_dir }}/bundle/private/blockscout/db_password"
    mode: "0600"
    content: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: not blockscout_db_password_stat.stat.exists

- name: Read blockscout DB password (controller-side)
  ansible.builtin.set_fact:
    blockscout_db_password: "{{ lookup('ansible.builtin.file', net_dir + '/bundle/private/blockscout/db_password') }}"
  no_log: true

- name: Check for stats DB password (controller-side)
  ansible.builtin.stat:
    path: "{{ net_dir }}/bundle/private/blockscout/stats_db_password"
  register: blockscout_stats_db_password_stat
  delegate_to: localhost
  become: false
  run_once: true

- name: Generate stats DB password (controller-side)
  ansible.builtin.copy:
    dest: "{{ net_dir }}/bundle/private/blockscout/stats_db_password"
    mode: "0600"
    content: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: not blockscout_stats_db_password_stat.stat.exists

- name: Read stats DB password (controller-side)
  ansible.builtin.set_fact:
    blockscout_stats_db_password: "{{ lookup('ansible.builtin.file', net_dir + '/bundle/private/blockscout/stats_db_password') }}"
  no_log: true

- name: Check for secret key base (controller-side)
  ansible.builtin.stat:
    path: "{{ net_dir }}/bundle/private/blockscout/secret_key_base"
  register: blockscout_secret_key_base_stat
  delegate_to: localhost
  become: false
  run_once: true

- name: Generate secret key base (controller-side)
  ansible.builtin.copy:
    dest: "{{ net_dir }}/bundle/private/blockscout/secret_key_base"
    mode: "0600"
    content: "{{ lookup('ansible.builtin.password', '/dev/null length=64 chars=ascii_letters,digits') }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: not blockscout_secret_key_base_stat.stat.exists

- name: Read secret key base (controller-side)
  ansible.builtin.set_fact:
    blockscout_secret_key_base: "{{ lookup('ansible.builtin.file', net_dir + '/bundle/private/blockscout/secret_key_base') }}"
  no_log: true

- name: Ensure blockscout base directory exists
  ansible.builtin.file:
    path: "{{ blockscout_base_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure blockscout envs directory exists
  ansible.builtin.file:
    path: "{{ blockscout_base_dir }}/envs"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure blockscout data directory exists
  ansible.builtin.file:
    path: "{{ blockscout_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure blockscout sensitive data directories exist (restricted)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0700"
  loop:
    - "{{ blockscout_postgres_data_dir }}"
    - "{{ blockscout_stats_postgres_data_dir }}"
    - "{{ blockscout_redis_data_dir }}"

- name: Ensure blockscout logs directory exists
  ansible.builtin.file:
    path: "{{ blockscout_logs_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

# --- Server-side image build (avoids QEMU emulation issues on macOS) ---
- name: Check if backend image exists on server
  ansible.builtin.command:
    cmd: docker image inspect {{ blockscout_backend_image }}
  register: blockscout_backend_image_check
  failed_when: false
  changed_when: false

- name: Check if frontend image exists on server
  ansible.builtin.command:
    cmd: docker image inspect {{ blockscout_frontend_image }}
  register: blockscout_frontend_image_check
  failed_when: false
  changed_when: false

- name: Verify wvm-blockscout source exists (controller)
  ansible.builtin.stat:
    path: "{{ blockscout_backend_src_dir }}/docker/Dockerfile"
  delegate_to: localhost
  become: false
  register: blockscout_backend_src_stat
  run_once: true

- name: Verify wvm-blockscout-frontend source exists (controller)
  ansible.builtin.stat:
    path: "{{ blockscout_frontend_src_dir }}/Dockerfile"
  delegate_to: localhost
  become: false
  register: blockscout_frontend_src_stat
  run_once: true

- name: Assert backend source or image is available
  ansible.builtin.assert:
    that:
      - blockscout_backend_image_check.rc == 0 or blockscout_backend_src_stat.stat.exists
    fail_msg: "Blockscout backend image not found and source missing; ensure wvm-blockscout is present or prebuild {{ blockscout_backend_image }}"

- name: Assert frontend source or image is available
  ansible.builtin.assert:
    that:
      - blockscout_frontend_image_check.rc == 0 or blockscout_frontend_src_stat.stat.exists
    fail_msg: "Blockscout frontend image not found and source missing; ensure wvm-blockscout-frontend is present or prebuild {{ blockscout_frontend_image }}"

- name: Ensure build directory exists on server
  ansible.builtin.file:
    path: /opt/blockscout-build
    state: directory
    mode: "0755"
  when: blockscout_backend_image_check.rc != 0 or blockscout_frontend_image_check.rc != 0

# --- Backend build ---
- name: Transfer wvm-blockscout source to server
  ansible.posix.synchronize:
    src: "{{ blockscout_backend_src_dir }}/"
    dest: /opt/blockscout-build/backend/
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=_build"
      - "--exclude=deps"
      - "--exclude=node_modules"
    delete: true
  when:
    - blockscout_backend_image_check.rc != 0
    - blockscout_backend_src_stat.stat.exists

- name: Build backend image on server
  ansible.builtin.command:
    cmd: >
      docker build
      --build-arg CACHE_EXCHANGE_RATES_PERIOD=""
      --build-arg API_V1_READ_METHODS_DISABLED=false
      --build-arg DISABLE_WEBAPP=false
      --build-arg API_V1_WRITE_METHODS_DISABLED=false
      --build-arg CACHE_TOTAL_GAS_USAGE_COUNTER_ENABLED=""
      --build-arg CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL=""
      --build-arg ADMIN_PANEL_ENABLED=""
      --build-arg RELEASE_VERSION={{ blockscout_release_version }}
      -t {{ blockscout_backend_image }}
      -f docker/Dockerfile
      .
    chdir: /opt/blockscout-build/backend
  when:
    - blockscout_backend_image_check.rc != 0
    - blockscout_backend_src_stat.stat.exists
  changed_when: true
  async: 1800
  poll: 30

# --- Frontend build ---
- name: Transfer wvm-blockscout-frontend source to server
  ansible.posix.synchronize:
    src: "{{ blockscout_frontend_src_dir }}/"
    dest: /opt/blockscout-build/frontend/
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=node_modules"
      - "--exclude=.next"
    delete: true
  when:
    - blockscout_frontend_image_check.rc != 0
    - blockscout_frontend_src_stat.stat.exists

- name: Build frontend image on server
  ansible.builtin.command:
    cmd: docker build -t {{ blockscout_frontend_image }} .
    chdir: /opt/blockscout-build/frontend
  when:
    - blockscout_frontend_image_check.rc != 0
    - blockscout_frontend_src_stat.stat.exists
  changed_when: true
  async: 1800
  poll: 30

- name: Cleanup build directory on server
  ansible.builtin.file:
    path: /opt/blockscout-build
    state: absent
  when: blockscout_backend_image_check.rc != 0 or blockscout_frontend_image_check.rc != 0

- name: Template common-blockscout.env
  ansible.builtin.template:
    src: "envs/common-blockscout.env.j2"
    dest: "{{ blockscout_base_dir }}/envs/common-blockscout.env"
    owner: root
    group: root
    mode: "0600"
  notify: Restart blockscout

- name: Template common-frontend.env
  ansible.builtin.template:
    src: "envs/common-frontend.env.j2"
    dest: "{{ blockscout_base_dir }}/envs/common-frontend.env"
    owner: root
    group: root
    mode: "0644"
  notify: Restart blockscout

- name: Template common-stats.env
  ansible.builtin.template:
    src: "envs/common-stats.env.j2"
    dest: "{{ blockscout_base_dir }}/envs/common-stats.env"
    owner: root
    group: root
    mode: "0600"
  notify: Restart blockscout

- name: Template common-visualizer.env
  ansible.builtin.template:
    src: "envs/common-visualizer.env.j2"
    dest: "{{ blockscout_base_dir }}/envs/common-visualizer.env"
    owner: root
    group: root
    mode: "0644"
  notify: Restart blockscout

- name: Template docker-compose.yml (restricted - contains secrets)
  ansible.builtin.template:
    src: "docker-compose.yml.j2"
    dest: "{{ blockscout_base_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0600"
  notify: Restart blockscout

- name: Template blockscout systemd unit
  ansible.builtin.template:
    src: "blockscout.service.j2"
    dest: "/etc/systemd/system/blockscout.service"
    owner: root
    group: root
    mode: "0644"
  notify: Reload systemd

- name: Install logrotate configuration for blockscout logs
  ansible.builtin.template:
    src: "blockscout-logrotate.j2"
    dest: "/etc/logrotate.d/blockscout"
    owner: root
    group: root
    mode: "0644"

- name: Enable and start blockscout service
  ansible.builtin.systemd:
    name: blockscout
    enabled: true
    daemon_reload: true
    state: stopped
