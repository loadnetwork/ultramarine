---
- name: Wipe host state for a network (destructive)
  hosts: all
  gather_facts: false
  become: true
  vars:
    loadnet_root: /opt/loadnet
    loadnet_current: "{{ loadnet_root }}/current"
    loadnet_networks: "{{ loadnet_root }}/networks"
    loadnet_net: "{{ net }}"
    loadnet_net_dir: "{{ loadnet_networks }}/{{ loadnet_net }}"
    loadnet_wipe_state: "{{ wipe_state | default(true) }}"
    loadnet_wipe_firewall: "{{ wipe_firewall | default(false) }}"
    loadnet_wipe_monitoring: "{{ wipe_monitoring | default(true) }}"
    loadnet_wipe_containers: "{{ wipe_containers | default(true) }}"
    loadnet_wipe_blockscout: "{{ wipe_blockscout | default(true) }}"
    loadnet_blockscout_base_dir: "/opt/loadnet/current/blockscout"
    loadnet_blockscout_data_dir: "/var/lib/blockscout"
    loadnet_wipe_confirm: "{{ wipe_confirm | default('') }}"
  tasks:
    - name: Assert required vars
      ansible.builtin.assert:
        that:
          - net is defined

    - name: Require explicit confirmation for destructive actions
      ansible.builtin.assert:
        that:
          - loadnet_wipe_confirm == "YES"
        fail_msg: "Refusing to wipe without wipe_confirm=YES"
      when: loadnet_wipe_state | bool or loadnet_wipe_firewall | bool or loadnet_wipe_monitoring | bool or loadnet_wipe_containers | bool or loadnet_wipe_blockscout | bool

    - name: Build node path lists
      ansible.builtin.set_fact:
        loadnet_node_state_paths: >-
          {{
            (loadnet_nodes | default([]))
            | map('regex_replace', '^', '/var/lib/load-reth/')
            | list
          }}
        loadnet_node_ultramarine_paths: >-
          {{
            (loadnet_nodes | default([]))
            | map('regex_replace', '^', '/var/lib/ultramarine/')
            | list
          }}
        loadnet_node_runtime_paths: >-
          {{
            (loadnet_nodes | default([]))
            | map('regex_replace', '^', '/run/load-reth/')
            | list
          }}

    - name: Resolve load-reth data root (follows symlink)
      ansible.builtin.command: "readlink -f /var/lib/load-reth"
      register: loadnet_load_reth_root
      changed_when: false
      failed_when: false

    - name: Resolve ultramarine data root (follows symlink)
      ansible.builtin.command: "readlink -f /var/lib/ultramarine"
      register: loadnet_ultramarine_root
      changed_when: false
      failed_when: false

    - name: Build resolved data paths (symlink targets)
      ansible.builtin.set_fact:
        loadnet_node_state_paths_resolved: >-
          {{
            (loadnet_nodes | default([]))
            | map('regex_replace', '^', (loadnet_load_reth_root.stdout | default('/var/lib/load-reth')) + '/')
            | list
          }}
        loadnet_node_ultramarine_paths_resolved: >-
          {{
            (loadnet_nodes | default([]))
            | map('regex_replace', '^', (loadnet_ultramarine_root.stdout | default('/var/lib/ultramarine')) + '/')
            | list
          }}

    - name: Stop ultramarine instances (best-effort)
      ansible.builtin.systemd:
        name: "ultramarine@{{ item }}.service"
        state: stopped
        enabled: false
      loop: "{{ loadnet_nodes | default([]) }}"
      ignore_errors: true

    - name: Remove systemd service.d overrides for load-reth (prevents stale config)
      ansible.builtin.file:
        path: "/etc/systemd/system/load-reth@{{ item }}.service.d"
        state: absent
      loop: "{{ loadnet_wipe_nodes | default([]) }}"
      when: loadnet_wipe_state | bool

    - name: Remove systemd service.d overrides for ultramarine (prevents stale config)
      ansible.builtin.file:
        path: "/etc/systemd/system/ultramarine@{{ item }}.service.d"
        state: absent
      loop: "{{ loadnet_wipe_nodes | default([]) }}"
      when: loadnet_wipe_state | bool

    - name: Reload systemd after removing overrides
      ansible.builtin.systemd:
        daemon_reload: true
      when: loadnet_wipe_state | bool

    - name: Stop load-reth instances (best-effort)
      ansible.builtin.systemd:
        name: "load-reth@{{ item }}.service"
        state: stopped
        enabled: false
      loop: "{{ loadnet_nodes | default([]) }}"
      ignore_errors: true

    - name: Stop monitoring services (best-effort)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - grafana.service
        - prometheus.service
      ignore_errors: true
      when: loadnet_wipe_monitoring | bool

    - name: Remove loadnet containers (best-effort)
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v docker >/dev/null 2>&1; then
          ids="$(docker ps -aq --filter 'name=^/load-reth-')"
          if [ -n "$ids" ]; then
            docker rm -f $ids >/dev/null 2>&1 || true
          fi
          ids="$(docker ps -aq --filter 'name=^/ultramarine-')"
          if [ -n "$ids" ]; then
            docker rm -f $ids >/dev/null 2>&1 || true
          fi
          docker rm -f loadnet-prometheus loadnet-grafana >/dev/null 2>&1 || true
        fi
      args:
        executable: /bin/bash
      when: loadnet_wipe_containers | bool

    - name: Wipe node state (optional)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop: "{{ loadnet_node_state_paths + loadnet_node_ultramarine_paths + loadnet_node_runtime_paths + loadnet_node_state_paths_resolved + loadnet_node_ultramarine_paths_resolved }}"
      when: loadnet_wipe_state | bool

    - name: Verify node state removed (optional)
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ loadnet_node_state_paths + loadnet_node_ultramarine_paths + loadnet_node_runtime_paths + loadnet_node_state_paths_resolved + loadnet_node_ultramarine_paths_resolved }}"
      register: loadnet_wipe_state_stats
      when: loadnet_wipe_state | bool

    - name: Assert node state removed (optional)
      ansible.builtin.assert:
        that:
          - not item.stat.exists
        fail_msg: "wipe_state=true but path still exists: {{ item.item }}"
      loop: "{{ loadnet_wipe_state_stats.results | default([]) }}"
      loop_control:
        label: "{{ item.item | default('') }}"
      when: loadnet_wipe_state | bool

    - name: Wipe monitoring state (optional)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/grafana
        - /var/lib/prometheus
      when: loadnet_wipe_monitoring | bool

    - name: Stop blockscout service (best-effort)
      ansible.builtin.systemd:
        name: blockscout.service
        state: stopped
        enabled: false
      ignore_errors: true
      when: loadnet_wipe_blockscout | bool

    - name: Remove blockscout containers and volumes via docker compose
      ansible.builtin.shell: |
        set -euo pipefail
        if [ -d "{{ loadnet_blockscout_base_dir }}" ] && [ -f "{{ loadnet_blockscout_base_dir }}/docker-compose.yml" ]; then
          cd "{{ loadnet_blockscout_base_dir }}"
          docker compose down -v --remove-orphans 2>/dev/null || true
        fi
      args:
        executable: /bin/bash
      when: loadnet_wipe_blockscout | bool

    - name: Wipe blockscout data directory (postgres, redis, logs)
      ansible.builtin.file:
        path: "{{ loadnet_blockscout_data_dir }}"
        state: absent
      when: loadnet_wipe_blockscout | bool

    - name: Remove blockscout docker network (prevents stale network labels)
      ansible.builtin.shell: |
        set -euo pipefail
        docker network rm blockscout-network 2>/dev/null || true
      args:
        executable: /bin/bash
      when: loadnet_wipe_blockscout | bool

    - name: Wipe network artifacts under /opt/loadnet (optional)
      ansible.builtin.file:
        path: "{{ loadnet_net_dir }}"
        state: absent
      when: loadnet_wipe_state | bool

    - name: Resolve /opt/loadnet/current target
      ansible.builtin.command: "readlink -f {{ loadnet_current }}"
      register: loadnet_current_target
      changed_when: false
      failed_when: false

    - name: Resolve selected network path
      ansible.builtin.command: "readlink -f {{ loadnet_net_dir }}"
      register: loadnet_net_target
      changed_when: false
      failed_when: false

    - name: Remove /opt/loadnet/current symlink if it points to this network
      ansible.builtin.file:
        path: "{{ loadnet_current }}"
        state: absent
      when:
        - loadnet_wipe_state | bool
        - loadnet_current_target.rc == 0
        - loadnet_net_target.rc == 0
        - loadnet_current_target.stdout | length > 0
        - loadnet_net_target.stdout | length > 0
        - loadnet_current_target.stdout == loadnet_net_target.stdout

    - name: Wipe firewall rules (optional; keeps SSH reachable by disabling ufw)
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v ufw >/dev/null 2>&1; then
          ufw --force reset
          ufw --force disable
        fi
      args:
        executable: /bin/bash
      when: loadnet_wipe_firewall | bool
