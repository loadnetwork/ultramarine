---
- name: Rolling restart Load services (serial=1)
  hosts: all
  gather_facts: true
  become: true
  serial: 1
  vars:
    loadnet_net: "{{ net }}"
    loadnet_net_dir: "{{ net_dir }}"
    loadnet_roll_confirm: "{{ roll_confirm | default('') }}"
  pre_tasks:
    - name: Assert required vars
      ansible.builtin.assert:
        that:
          - loadnet_net is defined
          - loadnet_net_dir is defined

    - name: Load lockfile
      ansible.builtin.set_fact:
        loadnet_lock: "{{ lookup('file', loadnet_net_dir + '/network.lock.json') | from_json }}"

    - name: Build node->ports map
      ansible.builtin.set_fact:
        loadnet_ports_by_node: >-
          {{
            dict(
              loadnet_lock.nodes
              | map(attribute='id')
              | zip(loadnet_lock.nodes | map(attribute='ports'))
            )
          }}

    - name: Assert lockfile matches selected network
      ansible.builtin.assert:
        that:
          - loadnet_lock.network.name == loadnet_net
        fail_msg: "network.lock.json is for '{{ loadnet_lock.network.name }}' but net='{{ loadnet_net }}'"

    - name: Require explicit confirmation when rolling restart may halt chain
      ansible.builtin.assert:
        that:
          - loadnet_roll_confirm == "YES"
        fail_msg: "Refusing to roll-restart with <=2 validators (halts chain) without roll_confirm=YES"
      when: (loadnet_lock.nodes | selectattr('role', 'equalto', 'validator') | list | length) <= 2

  tasks:
    - name: Stop ultramarine instances on host (best-effort)
      ansible.builtin.systemd:
        name: "ultramarine@{{ item }}.service"
        state: stopped
      loop: "{{ loadnet_nodes | default([]) }}"
      failed_when: false

    - name: Restart load-reth instances on host
      ansible.builtin.systemd:
        name: "load-reth@{{ item }}.service"
        state: restarted
        enabled: true
      loop: "{{ loadnet_nodes | default([]) }}"

    - name: Wait for load-reth engine IPC sockets
      ansible.builtin.wait_for:
        path: "/run/load-reth/{{ item }}/engine.ipc"
        state: present
        timeout: 90
      loop: "{{ loadnet_nodes | default([]) }}"

    - name: Wait for EL JSON-RPC to report not syncing
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ loadnet_ports_by_node[item].el_http }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          id: 1
          method: "eth_syncing"
          params: []
        return_content: true
        timeout: 2
      register: el_syncing_status
      retries: 30
      delay: 2
      until:
        - el_syncing_status.status == 200
        - el_syncing_status.json is defined
        # eth_syncing returns false when synced, or object with currentBlock/highestBlock when syncing
        # Consider synced if: result==false OR currentBlock >= highestBlock
        - >-
          el_syncing_status.json.result == false or
          (el_syncing_status.json.result is mapping and
           el_syncing_status.json.result.currentBlock is defined and
           el_syncing_status.json.result.highestBlock is defined and
           (el_syncing_status.json.result.currentBlock | int(base=16)) >= (el_syncing_status.json.result.highestBlock | int(base=16)))
      loop: "{{ loadnet_nodes | default([]) }}"
      changed_when: false

    - name: Restart ultramarine instances on host
      ansible.builtin.systemd:
        name: "ultramarine@{{ item }}.service"
        state: restarted
        enabled: true
      loop: "{{ loadnet_nodes | default([]) }}"

    - name: Restart monitoring services on host (best-effort)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        enabled: true
      loop:
        - prometheus.service
        - grafana.service
      failed_when: false
