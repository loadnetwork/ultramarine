---
- name: Net doctor (post-deploy)
  hosts: all
  gather_facts: true
  become: true
  vars:
    loadnet_root: /opt/loadnet
    loadnet_current: "{{ loadnet_root }}/current"
    loadnet_networks: "{{ loadnet_root }}/networks"
    loadnet_net: "{{ net }}"
    loadnet_net_dir: "{{ loadnet_networks }}/{{ loadnet_net }}"
    loadnet_expected_el_http_bind: "{{ loadnet_el_http_bind | default('0.0.0.0') }}"
    loadnet_root_fs_max_pct_value: "{{ loadnet_root_fs_max_pct | default(85) }}"
    loadnet_log_dir_path: "{{ loadnet_log_dir | default('/var/log') }}"
    loadnet_log_dir_max_mb_value: "{{ loadnet_log_dir_max_mb | default(4096) }}"
  tasks:
    - name: Assert required vars
      ansible.builtin.assert:
        that:
          - net is defined
          - net_dir is defined

    - name: Load lockfile
      ansible.builtin.set_fact:
        loadnet_lock: "{{ lookup('file', net_dir + '/network.lock.json') | from_json }}"

    - name: Assert lockfile matches selected network
      ansible.builtin.assert:
        that:
          - loadnet_lock.network.name == net
        fail_msg: "network.lock.json is for '{{ loadnet_lock.network.name }}' but net='{{ net }}'"

    - name: Verify required services are installed
      ansible.builtin.command: "systemctl is-enabled {{ item }}"
      loop:
        - docker
        - chrony
      changed_when: false
      failed_when: false
      register: enabled_services

    - name: Verify required services are active
      ansible.builtin.command: "systemctl is-active --quiet {{ item }}"
      loop:
        - docker
        - chrony
      changed_when: false
      register: active_services

    - name: Check fs.file-max baseline
      ansible.builtin.command: sysctl -n fs.file-max
      changed_when: false
      register: fs_file_max

    - name: Assert fs.file-max is sufficient
      ansible.builtin.assert:
        that:
          - (fs_file_max.stdout | int) >= 1048576
        fail_msg: "fs.file-max={{ fs_file_max.stdout }} is too low; expected >= 1048576"

    - name: Check root filesystem usage
      ansible.builtin.command: "df -P /"
      changed_when: false
      register: loadnet_root_df

    - name: Parse root filesystem usage
      ansible.builtin.set_fact:
        loadnet_root_pct: "{{ loadnet_root_df.stdout_lines[1].split()[4] | regex_replace('%', '') | int }}"
      changed_when: false
      failed_when: loadnet_root_df.stdout_lines | length < 2

    - name: Assert root filesystem usage below threshold
      ansible.builtin.assert:
        that:
          - loadnet_root_pct < (loadnet_root_fs_max_pct_value | int)
        fail_msg: "root filesystem usage {{ loadnet_root_pct }}% exceeds limit {{ loadnet_root_fs_max_pct_value }}%"

    - name: Check /var/log size
      ansible.builtin.command: "du -sm {{ loadnet_log_dir_path }}"
      changed_when: false
      register: loadnet_log_dir_size

    - name: Parse /var/log size
      ansible.builtin.set_fact:
        loadnet_log_dir_mb: "{{ loadnet_log_dir_size.stdout.split()[0] | int }}"
      changed_when: false
      failed_when: loadnet_log_dir_size.stdout | length == 0

    - name: Assert /var/log size below threshold
      ansible.builtin.assert:
        that:
          - loadnet_log_dir_mb < (loadnet_log_dir_max_mb_value | int)
        fail_msg: "/var/log size {{ loadnet_log_dir_mb }}MB exceeds limit {{ loadnet_log_dir_max_mb_value }}MB"

    - name: Check /opt/loadnet/current symlink exists
      ansible.builtin.stat:
        path: "{{ loadnet_current }}"
        follow: false
      register: current_link

    - name: Assert /opt/loadnet/current is a symlink
      ansible.builtin.assert:
        that:
          - current_link.stat.exists
          - current_link.stat.islnk
        fail_msg: "/opt/loadnet/current must be a symlink (run net-deploy first)"

    - name: Check installed systemd unit templates
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ item }}"
      loop:
        - load-reth@.service
        - ultramarine@.service
      register: unit_stats

    - name: Assert systemd unit templates exist
      ansible.builtin.assert:
        that:
          - unit_stats.results[0].stat.exists
          - unit_stats.results[1].stat.exists
        fail_msg: "missing systemd unit template(s); rerun net-deploy"

    - name: Check data mount exists (/var/lib/loadnet)
      ansible.builtin.command: "findmnt -n /var/lib/loadnet"
      changed_when: false
      register: findmnt_loadnet
      failed_when: false

    - name: Warn if /var/lib/loadnet is not mounted
      ansible.builtin.debug:
        msg: "/var/lib/loadnet is not mounted (recommended for validators). Run net-storage before go-live."
      when: findmnt_loadnet.rc != 0

    - name: Check docker data-root (if docker is running)
      ansible.builtin.shell: |
        set -euo pipefail
        docker info --format '{{"{{.DockerRootDir}}"}}'
      args:
        executable: /bin/bash
      changed_when: false
      register: docker_root
      failed_when: false

    - name: Show docker data-root
      ansible.builtin.debug:
        msg: "docker data-root: {{ docker_root.stdout | default('unknown') }}"

    - name: Build node->ports map (from lockfile)
      ansible.builtin.set_fact:
        loadnet_ports_by_node: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes | map(attribute='ports'))) }}"

    - name: Build node->role map (from lockfile)
      ansible.builtin.set_fact:
        loadnet_role_by_node: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes | map(attribute='role'))) }}"

    - name: Build validator node list
      ansible.builtin.set_fact:
        loadnet_validator_nodes: "{{ loadnet_lock.nodes | selectattr('role', 'equalto', 'validator') | map(attribute='id') | list }}"

    - name: Build local validator node list
      ansible.builtin.set_fact:
        loadnet_validator_nodes_local: "{{ loadnet_validator_nodes | intersect(loadnet_nodes) }}"

    - name: Build expected metrics bind (from lockfile policy)
      ansible.builtin.set_fact:
        loadnet_expected_metrics_bind: "{{ loadnet_lock.policy.metrics_bind | default('127.0.0.1') }}"

    - name: Normalize expected bind hosts for checks
      ansible.builtin.set_fact:
        loadnet_expected_el_http_host: "{{ '127.0.0.1' if loadnet_expected_el_http_bind in ['0.0.0.0', '::'] else loadnet_expected_el_http_bind }}"
        loadnet_expected_metrics_host: "{{ '127.0.0.1' if loadnet_expected_metrics_bind in ['0.0.0.0', '::'] else loadnet_expected_metrics_bind }}"

    - name: Check free disk space under /var/lib (best-effort)
      ansible.builtin.command: "df -Pk /var/lib"
      changed_when: false
      register: df_var_lib
      failed_when: false

    - name: Show /var/lib disk usage
      ansible.builtin.debug:
        var: df_var_lib.stdout_lines

    - name: Stat load-reth p2p key files
      ansible.builtin.stat:
        path: "/opt/loadnet/current/bundle/private/load-reth/p2p-keys/{{ item }}.key"
        follow: false
      loop: "{{ loadnet_nodes }}"
      register: reth_key_stats

    - name: Assert load-reth p2p keys are 0600
      ansible.builtin.assert:
        that:
          - reth_key_stats.results[ansible_loop.index0].stat.exists
          - reth_key_stats.results[ansible_loop.index0].stat.mode == "0600"
        fail_msg: "bad permissions for /opt/loadnet/current/bundle/private/load-reth/p2p-keys/{{ item }}.key (expected 0600)"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true

    - name: Stat validator priv_validator_key.json files (local nodes only)
      ansible.builtin.stat:
        path: "/var/lib/ultramarine/{{ item }}/config/priv_validator_key.json"
        follow: false
      loop: "{{ loadnet_validator_nodes_local }}"
      register: validator_key_stats

    - name: Assert validator priv_validator_key.json is 0600 (local nodes only)
      ansible.builtin.assert:
        that:
          - validator_key_stats.results[ansible_loop.index0].stat.exists
          - validator_key_stats.results[ansible_loop.index0].stat.mode == "0600"
        fail_msg: "bad permissions for /var/lib/ultramarine/{{ item }}/config/priv_validator_key.json (expected 0600)"
      loop: "{{ loadnet_validator_nodes_local }}"
      loop_control:
        extended: true

    - name: Check load-reth service active (postflight)
      ansible.builtin.command: "systemctl is-active --quiet load-reth@{{ item }}.service"
      loop: "{{ loadnet_nodes }}"
      register: load_reth_active
      changed_when: false
      failed_when: false

    - name: Check ultramarine service active (postflight)
      ansible.builtin.command: "systemctl is-active --quiet ultramarine@{{ item }}.service"
      loop: "{{ loadnet_nodes }}"
      register: ultramarine_active
      changed_when: false
      failed_when: false

    - name: Read ultramarine config.toml (local nodes)
      ansible.builtin.slurp:
        src: "/var/lib/ultramarine/{{ item }}/config/config.toml"
      loop: "{{ loadnet_nodes }}"
      register: ultramarine_config
      failed_when: false
      changed_when: false

    - name: Build mempool enabled map
      ansible.builtin.set_fact:
        loadnet_mempool_enabled: >-
          {{
            loadnet_mempool_enabled | default({})
            | combine({
                item.item: (
                  (
                    item.content is defined
                    and (
                      (item.content | b64decode)
                      | regex_findall('^max_tx_count\\s*=\\s*(\\d+)', multiline=True)
                      | first
                      | default('0', true)
                    ) | int > 0
                  )
                )
              })
          }}
      loop: "{{ ultramarine_config.results }}"
      changed_when: false

    - name: Capture listening sockets
      ansible.builtin.command: ss -lntu
      changed_when: false
      register: ss_listen

    - name: Assert load-reth P2P listener
      ansible.builtin.assert:
        that:
          - ss_listen.stdout is search(':' ~ loadnet_ports_by_node[item].el_p2p ~ '\\b')
        fail_msg: "missing listener for load-reth p2p port {{ loadnet_ports_by_node[item].el_p2p }} (node={{ item }})"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true
      when: load_reth_active.results[ansible_loop.index0].rc == 0

    - name: Wait for load-reth HTTP listener
      ansible.builtin.wait_for:
        host: "{{ loadnet_expected_el_http_host }}"
        port: "{{ loadnet_ports_by_node[item.item].el_http }}"
        timeout: 2
      loop: "{{ load_reth_active.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.rc == 0
      changed_when: false

    - name: Wait for load-reth metrics listener
      ansible.builtin.wait_for:
        host: "127.0.0.1"
        port: "{{ loadnet_ports_by_node[item.item].el_metrics }}"
        timeout: 2
      loop: "{{ load_reth_active.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.rc == 0
      changed_when: false

    - name: Assert ultramarine consensus P2P listener
      ansible.builtin.assert:
        that:
          - ss_listen.stdout is search(':' ~ loadnet_ports_by_node[item].cl_p2p ~ '\\b')
        fail_msg: "missing listener for ultramarine cl_p2p port {{ loadnet_ports_by_node[item].cl_p2p }} (node={{ item }})"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true
      when: ultramarine_active.results[ansible_loop.index0].rc == 0

    - name: Assert ultramarine mempool listener (when enabled)
      ansible.builtin.assert:
        that:
          - ss_listen.stdout is search(':' ~ loadnet_ports_by_node[item].cl_mempool ~ '\\b')
        fail_msg: "missing listener for ultramarine cl_mempool port {{ loadnet_ports_by_node[item].cl_mempool }} (node={{ item }})"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true
      when:
        - ultramarine_active.results[ansible_loop.index0].rc == 0
        - loadnet_mempool_enabled[item] | default(false)

    - name: Warn if ultramarine mempool is disabled
      ansible.builtin.debug:
        msg: "ultramarine mempool disabled (max_tx_count=0), skipping listener check (node={{ item }})"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true
      when:
        - ultramarine_active.results[ansible_loop.index0].rc == 0
        - not (loadnet_mempool_enabled[item] | default(true))

    - name: Warn if ultramarine mempool config is missing
      ansible.builtin.debug:
        msg: "ultramarine config.toml missing or unreadable; skipping mempool listener check (node={{ item }})"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true
      when:
        - ultramarine_active.results[ansible_loop.index0].rc == 0
        - item not in loadnet_mempool_enabled

    - name: Wait for ultramarine metrics listener
      ansible.builtin.wait_for:
        host: "{{ loadnet_expected_metrics_host }}"
        port: "{{ loadnet_ports_by_node[item.item].cl_metrics }}"
        timeout: 2
      loop: "{{ ultramarine_active.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.rc == 0
      changed_when: false
