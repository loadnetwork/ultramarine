---
- name: Deploy Load testnet services
  hosts: all
  gather_facts: true
  become: true
  vars:
    loadnet_root: /opt/loadnet
    loadnet_current: "{{ loadnet_root }}/current"
    loadnet_networks: "{{ loadnet_root }}/networks"
    loadnet_net: "{{ net }}"
    loadnet_net_dir: "{{ loadnet_networks }}/{{ loadnet_net }}"
    # Avoid self-referential defaults (which can cause recursive loop errors in Jinja).
    # Extra-vars (from `make net-deploy ...`) override these safely.
    restart_on_deploy: true
    apply_firewall: false
  pre_tasks:
    - name: Assert required vars
      ansible.builtin.assert:
        that:
          - net is defined
          - net_dir is defined
    - name: Load lockfile
      ansible.builtin.set_fact:
        loadnet_lock: "{{ lookup('file', net_dir + '/network.lock.json') | from_json }}"
    - name: Assert lockfile matches selected network
      ansible.builtin.assert:
        that:
          - loadnet_lock.network.name == net
        fail_msg: "network.lock.json is for '{{ loadnet_lock.network.name }}' but net='{{ net }}'"

    - name: Resolve repo root on controller
      ansible.builtin.set_fact:
        loadnet_repo_root: "{{ playbook_dir | dirname | dirname | dirname }}"

    - name: Resolve manifest path on controller
      ansible.builtin.set_fact:
        loadnet_manifest_path: >-
          {{
            (loadnet_lock.inputs.manifest_path is match('^/'))
            | ternary(loadnet_lock.inputs.manifest_path, loadnet_repo_root + '/' + loadnet_lock.inputs.manifest_path)
          }}

    - name: Compute manifest sha256 on controller (drift check)
      ansible.builtin.stat:
        path: "{{ loadnet_manifest_path }}"
        checksum_algorithm: sha256
      delegate_to: localhost
      become: false
      register: manifest_stat

    - name: Fail fast on manifest/lock drift
      ansible.builtin.assert:
        that:
          - manifest_stat.stat.exists
          - manifest_stat.stat.checksum == loadnet_lock.inputs.manifest_sha256
        fail_msg: "manifest changed since lockfile was generated; rerun netgen (make net-gen NET={{ net }})"
  roles:
    - common
    - { role: firewall, when: apply_firewall | bool }
    - load_reth
    - ultramarine
    - monitoring
  post_tasks:
    - name: Point /opt/loadnet/current to selected network
      ansible.builtin.file:
        src: "{{ loadnet_net_dir }}"
        dest: "{{ loadnet_current }}"
        state: link
        force: true
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Ensure load-reth instances are running
      ansible.builtin.systemd:
        name: "load-reth@{{ item }}.service"
        enabled: true
        state: "{{ (restart_on_deploy | bool) | ternary('restarted', 'started') }}"
      loop: "{{ loadnet_nodes }}"

    - name: Check for stale load-reth containers that block restarts
      ansible.builtin.command:
        cmd: "docker inspect -f '{{\"{{\"}}.State.Status{{\"}}\"}}' load-reth-{{ item }}"
      register: load_reth_container_status
      loop: "{{ loadnet_nodes }}"
      changed_when: false
      failed_when: false
      when: restart_on_deploy | bool

    - name: Remove stale load-reth containers
      ansible.builtin.command:
        cmd: "docker rm -f load-reth-{{ item.item }}"
      loop: "{{ load_reth_container_status.results }}"
      loop_control:
        label: "{{ item.item }}"
      changed_when: true
      when:
        - restart_on_deploy | bool
        - item.rc == 0
        - item.stdout in ['exited', 'dead', 'created']

    - name: Wait for load-reth engine IPC sockets
      ansible.builtin.wait_for:
        path: "/run/load-reth/{{ item }}/engine.ipc"
        state: present
        timeout: 90
      loop: "{{ loadnet_nodes }}"

    - name: Ensure ultramarine instances are running
      ansible.builtin.systemd:
        name: "ultramarine@{{ item }}.service"
        enabled: true
        state: "{{ (restart_on_deploy | bool) | ternary('restarted', 'started') }}"
      loop: "{{ loadnet_nodes }}"

    - name: Ensure Prometheus is running (monitoring)
      ansible.builtin.systemd:
        name: prometheus.service
        enabled: true
        state: "{{ (restart_on_deploy | bool) | ternary('restarted', 'started') }}"

    - name: Ensure Grafana is running (monitoring)
      ansible.builtin.systemd:
        name: grafana.service
        enabled: true
        state: "{{ (restart_on_deploy | bool) | ternary('restarted', 'started') }}"

    - name: Wait for Grafana container to be running
      ansible.builtin.command:
        argv:
          - docker
          - inspect
          - -f
          - '{{"{{"}}.State.Running{{"}}"}}'
          - loadnet-grafana
      register: loadnet_grafana_container_state
      changed_when: false
      retries: 10
      delay: 3
      until: loadnet_grafana_container_state.rc == 0 and loadnet_grafana_container_state.stdout == "true"
      when:
        - loadnet_grafana_admin_password_value is defined
        - (loadnet_grafana_admin_password_value | length) > 0

    - name: Enforce Grafana admin password from deploy bundle
      ansible.builtin.command:
        argv:
          - docker
          - exec
          - loadnet-grafana
          - grafana-cli
          - admin
          - reset-admin-password
          - "{{ loadnet_grafana_admin_password_value }}"
      register: loadnet_grafana_password_reset
      retries: 5
      delay: 2
      until: loadnet_grafana_password_reset.rc == 0
      changed_when: loadnet_grafana_password_reset.rc == 0
      no_log: true
      when:
        - loadnet_grafana_admin_password_value is defined
        - (loadnet_grafana_admin_password_value | length) > 0
