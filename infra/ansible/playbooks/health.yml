---
- name: Health check (process + height moving)
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Load lockfile
      ansible.builtin.set_fact:
        loadnet_lock: "{{ lookup('file', net_dir + '/network.lock.json') | from_json }}"

    - name: Build node->ports map
      ansible.builtin.set_fact:
        loadnet_ports_by_node: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes | map(attribute='ports'))) }}"

    - name: Build node->engine IPC path map
      ansible.builtin.set_fact:
        loadnet_engine_ipc_by_node: "{{ dict(loadnet_lock.nodes | map(attribute='id') | zip(loadnet_lock.nodes | map(attribute='engine') | map(attribute='ipc_path'))) }}"

    - name: Build metrics scrape host (from lockfile policy)
      ansible.builtin.set_fact:
        loadnet_metrics_bind: "{{ loadnet_lock.policy.metrics_bind | default('127.0.0.1') }}"

    - name: Normalize metrics scrape host
      ansible.builtin.set_fact:
        loadnet_metrics_scrape_host: "{{ '127.0.0.1' if loadnet_metrics_bind in ['0.0.0.0', '::'] else loadnet_metrics_bind }}"

    - name: Assert load-reth service is active
      ansible.builtin.command: "systemctl is-active --quiet load-reth@{{ item }}.service"
      loop: "{{ loadnet_nodes }}"
      changed_when: false

    - name: Assert ultramarine service is active
      ansible.builtin.command: "systemctl is-active --quiet ultramarine@{{ item }}.service"
      loop: "{{ loadnet_nodes }}"
      changed_when: false

    - name: Assert Engine IPC socket exists
      ansible.builtin.stat:
        path: "{{ loadnet_engine_ipc_by_node[item] }}"
      loop: "{{ loadnet_nodes }}"
      register: engine_ipc_stats

    - name: Ensure Engine IPC is a socket
      ansible.builtin.assert:
        that:
          - engine_ipc_stats.results[ansible_loop.index0].stat.exists
          - engine_ipc_stats.results[ansible_loop.index0].stat.issock
        fail_msg: "missing Engine IPC socket for {{ item }} at {{ loadnet_engine_ipc_by_node[item] }}"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true

    - name: Check EL JSON-RPC responds
      ansible.builtin.shell: |
        set -euo pipefail
        node="{{ item }}"
        port="{{ loadnet_ports_by_node[node].el_http }}"
        resp="$(curl -fsS --max-time 2 -H 'Content-Type: application/json' \
          --data '{"jsonrpc":"2.0","id":1,"method":"web3_clientVersion","params":[]}' \
          "http://127.0.0.1:${port}")"
        echo "$resp" | jq -e '.result' >/dev/null
      args:
        executable: /bin/bash
      loop: "{{ loadnet_nodes }}"
      changed_when: false

    - name: Scrape height twice and ensure it changes
      ansible.builtin.shell: |
        set -euo pipefail
        node="{{ item }}"
        port="{{ (loadnet_ports_by_node[node].cl_metrics) | default(0) }}"
        if [ "$port" = "0" ]; then
          echo "missing cl_metrics port for $node" >&2
          exit 1
        fi
        h1="$(curl -fsS "http://{{ loadnet_metrics_scrape_host }}:${port}/metrics" | awk '/^malachitebft_core_consensus_height / {print $2; exit}')"
        sleep 5
        h2="$(curl -fsS "http://{{ loadnet_metrics_scrape_host }}:${port}/metrics" | awk '/^malachitebft_core_consensus_height / {print $2; exit}')"
        echo "$node $h1 $h2"
        test "$h1" != "$h2"
      args:
        executable: /bin/bash
      loop: "{{ loadnet_nodes }}"
      register: height_checks
      changed_when: false
