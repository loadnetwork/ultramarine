---
- name: Health check (process + height moving)
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Load lockfile
      ansible.builtin.set_fact:
        loadnet_lock: "{{ lookup('file', net_dir + '/network.lock.json') | from_json }}"

    - name: Build node->ports map
      ansible.builtin.set_fact:
        loadnet_ports_by_node: >-
          {{
            dict(
              loadnet_lock.nodes
              | map(attribute='id')
              | zip(loadnet_lock.nodes | map(attribute='ports'))
            )
          }}

    - name: Build node->engine IPC path map
      ansible.builtin.set_fact:
        loadnet_engine_ipc_by_node: >-
          {{
            dict(
              loadnet_lock.nodes
              | map(attribute='id')
              | zip(loadnet_lock.nodes | map(attribute='engine') | map(attribute='ipc_path'))
            )
          }}

    - name: Build metrics scrape host (from lockfile policy)
      ansible.builtin.set_fact:
        loadnet_metrics_bind: "{{ loadnet_lock.policy.metrics_bind | default('127.0.0.1') }}"

    - name: Define metrics regex helpers
      ansible.builtin.set_fact:
        loadnet_height_regex: >-
          ^malachitebft_core_consensus_height(?:\\{[^}]*\\})?\\s+(\\d+)
        loadnet_height_match_regex: >-
          ^malachitebft_core_consensus_height(?:\\{[^}]*\\})?\\s+\\d+

    - name: Normalize metrics scrape host
      ansible.builtin.set_fact:
        loadnet_metrics_scrape_host: "{{ '127.0.0.1' if loadnet_metrics_bind in ['0.0.0.0', '::'] else loadnet_metrics_bind }}"

    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Assert load-reth service is active
      ansible.builtin.assert:
        that:
          - ansible_facts.services['load-reth@' + item + '.service'] is defined
          - ansible_facts.services['load-reth@' + item + '.service'].state == 'running'
        fail_msg: "load-reth@{{ item }}.service is not running"
      loop: "{{ loadnet_nodes }}"

    - name: Assert ultramarine service is active
      ansible.builtin.assert:
        that:
          - ansible_facts.services['ultramarine@' + item + '.service'] is defined
          - ansible_facts.services['ultramarine@' + item + '.service'].state == 'running'
        fail_msg: "ultramarine@{{ item }}.service is not running"
      loop: "{{ loadnet_nodes }}"

    - name: Assert Engine IPC socket exists
      ansible.builtin.stat:
        path: "{{ loadnet_engine_ipc_by_node[item] }}"
      loop: "{{ loadnet_nodes }}"
      register: engine_ipc_stats

    - name: Ensure Engine IPC is a socket
      ansible.builtin.assert:
        that:
          - engine_ipc_stats.results[ansible_loop.index0].stat.exists
          - engine_ipc_stats.results[ansible_loop.index0].stat.issock
        fail_msg: "missing Engine IPC socket for {{ item }} at {{ loadnet_engine_ipc_by_node[item] }}"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true

    - name: Check EL JSON-RPC responds
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ loadnet_ports_by_node[item].el_http }}"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          id: 1
          method: "web3_clientVersion"
          params: []
        return_content: true
        timeout: 2
      loop: "{{ loadnet_nodes }}"
      register: el_rpc
      changed_when: false

    - name: Assert EL JSON-RPC returned result
      ansible.builtin.assert:
        that:
          - el_rpc.results[ansible_loop.index0].status == 200
          - el_rpc.results[ansible_loop.index0].json is defined
          - el_rpc.results[ansible_loop.index0].json.result is defined
        fail_msg: "EL JSON-RPC did not return result for {{ item }}"
      loop: "{{ loadnet_nodes }}"
      loop_control:
        extended: true

    - name: Assert CL metrics ports are set
      ansible.builtin.assert:
        that:
          - (loadnet_ports_by_node[item].cl_metrics | default(0) | int) > 0
        fail_msg: "missing cl_metrics port for {{ item }}"
      loop: "{{ loadnet_nodes }}"

    - name: Fetch initial CL metrics
      ansible.builtin.uri:
        url: "http://{{ loadnet_metrics_scrape_host }}:{{ loadnet_ports_by_node[item].cl_metrics }}/metrics"
        return_content: true
        timeout: 2
      loop: "{{ loadnet_nodes }}"
      register: cl_metrics_first
      changed_when: false

    - name: Record initial CL heights
      ansible.builtin.set_fact:
        loadnet_cl_height_first: >-
          {{
            loadnet_cl_height_first | default({})
            | combine({
                item.item: (
                  item.content
                  | regex_findall(loadnet_height_regex, multiline=True)
                  | first
                  | default('0', true)
                  | int
                )
              })
          }}
      loop: "{{ cl_metrics_first.results }}"
      changed_when: false
      failed_when: item.content is not search(loadnet_height_match_regex, multiline=True)

    - name: Fetch CL metrics until height advances
      ansible.builtin.uri:
        url: "http://{{ loadnet_metrics_scrape_host }}:{{ loadnet_ports_by_node[item].cl_metrics }}/metrics"
        return_content: true
        timeout: 2
      loop: "{{ loadnet_nodes }}"
      register: cl_metrics_second
      changed_when: false
      retries: 3
      delay: 15
      until: >-
        (cl_metrics_second.content is defined)
        and (cl_metrics_second.content is search(loadnet_height_match_regex, multiline=True))
        and
        (
          (cl_metrics_second.content | regex_findall(loadnet_height_regex, multiline=True) | first | default('0', true) | int)
          != (loadnet_cl_height_first[item] | int)
        )

    - name: Record updated CL heights
      ansible.builtin.set_fact:
        loadnet_cl_height_second: >-
          {{
            loadnet_cl_height_second | default({})
            | combine({
                item.item: (
                  item.content
                  | regex_findall(loadnet_height_regex, multiline=True)
                  | first
                  | default('0', true)
                  | int
                )
              })
          }}
      loop: "{{ cl_metrics_second.results }}"
      changed_when: false
